<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas de Formatação</title>
    <style>body{font-family:sans-serif;margin:0;padding:20px;transition:background-color .3s,color .3s}.container{background-color:#fff;padding:30px;border-radius:8px;width:80%;max-width:900px;margin:20px auto;transition:background-color .3s,box-shadow .3s}h1,h2,p{text-align:center}label{font-weight:700;margin-top:15px;display:block}textarea{width:98%;min-height:150px;padding:10px;margin-top:5px;border:1px solid;border-radius:6px;font-size:14px;resize:vertical;transition:background-color .3s,color .3s,border-color .3s}.buttons{text-align:center;margin-top:20px}button{color:#fff;border:none;padding:10px 20px;border-radius:6px;font-size:16px;cursor:pointer;margin:5px;transition:background-color .3s}button:disabled{background-color:#5a6268;cursor:not-allowed}hr{border:0;height:1px;margin:40px 0;transition:background-color .3s}#theme-toggle{position:fixed;top:20px;right:20px;z-index:1000}.light-theme{background-color:#f0f2f5;color:#1c1e21}.light-theme .container{background-color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1),0 8px 16px rgba(0,0,0,.1)}.light-theme textarea{background-color:#fff;color:#1c1e21;border-color:#dddfe2}.light-theme hr{background-color:#dddfe2}.light-theme button{background-color:#1877f2}.light-theme button:hover{background-color:#166fe5}.light-theme .copy-button{background-color:#42b72a}.light-theme .copy-button:hover{background-color:#36a420}.dark-theme{background-color:#18191a;color:#e4e6eb}.dark-theme .container{background-color:#242526;box-shadow:0 2px 4px rgba(0,0,0,.3),0 8px 16px rgba(0,0,0,.3)}.dark-theme textarea{background-color:#3a3b3c;color:#e4e6eb;border-color:#4e4f50}.dark-theme hr{background-color:#3a3b3c}.dark-theme button{background-color:#2374e1}.dark-theme button:hover{background-color:#3982e4}.dark-theme .copy-button{background-color:#3d9c28}.dark-theme .copy-button:hover{background-color:#49b831}</style>
</head>
<body class="light-theme">

    <button id="theme-toggle" onclick="toggleTheme()">Mudar Tema</button>

    <div class="container">
        <h1>Formatador de Chamados (Suporte Externo)</h1>
        <textarea id="csvInputExterno" placeholder="Cole aqui os dados de Suporte Externo (que começam com ID de 6 dígitos)..."></textarea>
        <div class="buttons">
            <button id="format-button-externo" onclick="formatarSuporteExterno()">Formatar Suporte</button>
        </div>
        <textarea id="outputExterno" readonly placeholder="Resultado do Suporte Externo..."></textarea>
        <div class="buttons">
            <button class="copy-button" onclick="copiarResultado('outputExterno')">Copiar</button>
        </div>
    </div>
    
    <hr>

    <div class="container">
        <h1>Formatador de Retiradas (Cancelamento)</h1>
        <textarea id="csvInputRetiradas" placeholder="Cole aqui os dados de Retiradas (que começam com data)..."></textarea>
        <div class="buttons">
            <button id="format-button-retiradas" onclick="formatarRetiradas()">Formatar Retiradas</button>
        </div>
        <textarea id="outputRetiradas" readonly placeholder="Resultado das Retiradas..."></textarea>
        <div class="buttons">
            <button class="copy-button" onclick="copiarResultado('outputRetiradas')">Copiar</button>
        </div>
    </div>
    
    <script>
        // --- LÓGICA GERAL ---
        const RENDER_URL = 'https://render-server-blgr.onrender.com';
        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
        function cleanField(text) { return text ? text.trim().replace(/^"|"$/g, '') : ''; }
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-theme');
            document.body.classList.toggle('light-theme', !isDark);
            localStorage.setItem('theme', isDark ? 'dark-theme' : 'light-theme');
        }
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'light-theme';
            document.body.className = savedTheme;
        })();
        function copiarResultado(elementId) {
            navigator.clipboard.writeText(document.getElementById(elementId).value).then(() => alert('Resultado copiado!'));
        }
        async function callApi(url, textPayload) {
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ texto: textPayload }) });
                if (!response.ok) return `Erro no servidor (${response.status})`;
                const data = await response.json();
                return data.resumo || data.periodo_contato || "Sem resposta da IA";
            } catch (error) { return "ERRO DE CONEXÃO"; }
        }

        // --- LÓGICA DA FERRAMENTA 1: SUPORTE EXTERNO ---
        async function formatarSuporteExterno() {
            const btn = document.getElementById('format-button-externo');
            const output = document.getElementById('outputExterno');
            btn.disabled = true; btn.textContent = 'Processando...';

            const inputText = document.getElementById('csvInputExterno').value.trim();
            const records = inputText.match(/\d{6};.*/g) || []; // Encontra todas as linhas que começam com ID de 6 dígitos

            if (records.length === 0) { alert("Nenhum dado de Suporte Externo válido encontrado."); btn.disabled = false; btn.textContent = 'Formatar Suporte'; return; }
            
            let allFormattedLines = [];
            const COL = { cliente: 6, mensagem: 11, bairro: 12, whatsapp: 14 };

            for (let i = 0; i < records.length; i++) {
                output.value = `Processando Suporte ${i + 1} de ${records.length}...`;
                const columns = records[i].split(';');
                if (columns.length > COL.whatsapp) {
                    const assunto = await callApi(`${RENDER_URL}/resumir`, cleanField(columns[COL.mensagem]));
                    const dataLine = `${cleanField(columns[COL.cliente])} - ${cleanField(columns[COL.bairro])} - ${assunto} - ${cleanField(columns[COL.whatsapp])} - D1`; // Adicionado D1 como padrão
                    allFormattedLines.push(dataLine);
                    if (i < records.length - 1) await sleep(4000);
                }
            }
            output.value = allFormattedLines.join('\n');
            btn.disabled = false; btn.textContent = 'Formatar Suporte Externo';
        }

        // --- LÓGICA DA FERRAMENTA 2: RETIRADAS ---
        async function formatarRetiradas() {
            const btn = document.getElementById('format-button-retiradas');
            const output = document.getElementById('outputRetiradas');
            btn.disabled = true; btn.textContent = 'Processando...';

            const inputText = document.getElementById('csvInputRetiradas').value.trim();
            const records = inputText.match(/"\d{2}\/\d{2}\/\d{4}.*/g) || []; // Encontra todas as linhas que começam com data entre aspas
            
            if (records.length === 0) { alert("Nenhum dado de Retirada válido encontrado."); btn.disabled = false; btn.textContent = 'Formatar Retiradas'; return; }

            let allFormattedLines = [];
            const COL = { cliente: 2, mensagem: 6, bairro: 7, whatsapp: 9 };

            for (let i = 0; i < records.length; i++) {
                output.value = `Processando Retirada ${i + 1} de ${records.length}...`;
                const columns = records[i].split(';');
                if (columns.length > COL.whatsapp) {
                    const periodo = await callApi(`${RENDER_URL}/extrair-retirada`, cleanField(columns[COL.mensagem]));
                    const dataLine = `${cleanField(columns[COL.cliente])} - ${cleanField(columns[COL.bairro])} - cancelamento - ${periodo} - ${cleanField(columns[COL.whatsapp])}`;
                    allFormattedLines.push(dataLine);
                    if (i < records.length - 1) await sleep(4000);
                }
            }
            output.value = allFormattedLines.join('\n');
            btn.disabled = false; btn.textContent = 'Formatar Retiradas';
        }
    </script>
</body>
</html>
